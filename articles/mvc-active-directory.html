<html>
    <head>
        <title>MVC 5 and Active Directory</title>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>

    <body>

        <h1>ASP.NET MVC 5 and Active Directory</h1>

        <div id="article">
            <h2>Controller</h2>
            Here I've used the following imports:
            <ul>
                <li>System.ComponentModel.DataAnnotations</li>
                <li>System.EnterpriseServices</li>
                <li>System.Web</li>
                <li>ADAuthenication.Models</li>
                <li>Microsoft.Owin.Security</li>
            </ul>


            For authentication we use the following:</br>
            <code>
                IAuthenticationManager authenticationManager = HttpContext.GetOwinContext().Authentication;</br>
                var authService = new AdAuthenticationService(authenticationManager);
            </code>

            To get the user name and password from the model:</br>
            <code>
                var authenticationResult = authService.SignIn(model.Username, model.Password);</br>
                if (authenticationResult.IsSuccess())</br>
                {</br>
                    return RedirectToLocal("/Home/Index");</br>
                }
            </code></br>

            And for the anti-forgery token:</br>
            <code>
                [ValidateAntiForgeryToken]</br>
                public virtual ActionResult Logoff()</br>
                {</br>
                    IAuthenticationManager authenticationManager = HttpContext.GetOwinContext().Authentication;</br>
                    authenticationManager.SignOut(MyAuthentication.ApplicationCookie);</br>
                    return RedirectToAction("Index");</br>
                }
            </code></br>

            And lastly the login view model:</br>
            <code>
                public class LoginViewModel</br>
                {</br>
                    [Required, AllowHtml]</br>
                    public string Username{ get; set; }</br></br>
        
                    [Required]</br>
                    [AllowHtml]</br>
                    [DataType(DataType.Password)]</br>
                    public string Password { get; set;</br> }
                }
                </code>
        </div>
       
        <div id="article">
            <h2>Model</h2>
            The model uses:</br>
            <ul>
                <li>System.Net</li>
                <li>System.Security.Claims</li>
                <li>Microsoft.Owin.Security</li>
                <li>System.DirectoryServices.AccountManagement</li>
                <li>ADAuthenication</li>
                <li>System.Configuration</li>
                <li>System.Diagnostics.Eventing.Reader</li>
            </ul>

            The model is actually where the business logic is for Active Directory authentication. It performs and LDAP lookup to check whether the user name exists and checks the password with the Domain Controller.</br></br>

            It takes the following variables:</br>
            <code>
                string myAccount = ConfigurationManager.AppSettings["MyServiceAccount"].ToString();</br>
                string myPassword = ConfigurationManager.AppSettings["MyServicePassword"].ToString();</br>
                var myDomain = ConfigurationManager.ConnectionStrings["ADConnection"].ToString()
            </code>


            And connects with the LDAP with:</br>
            <code>
                PrincipalContext principalContext = new PrincipalContext(ContextType.Domain,myDomain.Replace("LDAP://", "");
            </code>
        </div>


        <div id="article">
            <h2>References</h2>

        </div>

        <div id="footer">Michael, April 2017</div>
    </body>
</html>
